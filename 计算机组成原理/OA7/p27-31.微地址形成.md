非常好！这部分课件深入到了微程序控制的“灵魂”所在——**控制流的转移**。它解决了微程序如何像普通程序一样，实现顺序、分支和循环的问题。

我们来彻底讲清楚这两种主流的微地址形成方法。

### 核心问题：下一条微指令在哪？

执行完当前微指令后，如何找到下一条？这决定了微程序的执行流程。

---

### 一、微程序入口地址的确定（从“取指”到“执行”的跳转）

这是所有指令执行的第一步，是一个**强制性的多路分支**。

1.  **执行“取指”微程序**：这是一个所有指令公用的微程序片段，负责把一条机器指令从内存取到 **IR** 中。
2.  **功能转移**：根据 **IR 中的操作码**，跳转到对应指令的微程序起始地址。
    - **一级功能转移**：操作码直接、一次性决定入口地址。适合操作码位置固定、长度统一的指令系统。
    - **多级功能转移**：像查字典一样，先根据操作码高位确定一个大类（如算术运算），再根据低位确定具体指令（如加法）。适合复杂、变长的指令系统（如CISC）。
    - **硬件实现**：通常用一个 **PROM（可编程只读存储器）** 或 **PLA（可编程逻辑阵列）** 来实现。输入是操作码，输出就是对应的微程序入口地址。

**比喻**：这是一个**总调度中心**。快递分拣机（取指微程序）把包裹（机器指令）拿来，扫描条形码（操作码），然后根据条形码把它扔到对应的“北京线”、“上海线”的传送带起点（微程序入口地址）。

---

### 二、后续微地址的产生（微程序内部的执行）

确定了入口，微程序开始执行。其内部的流程控制有两种主流方法：

#### 1. 计数器方式 (μPC 方式)

- **原理**：模仿机器指令的 **PC**。设置一个 **微程序计数器 (μPC)**。
    - **顺序执行**：`(μPC) + 1 -> μPC`
    - **转移执行**：当需要跳转时，由当前微指令的“转移地址”字段直接提供一个新地址，装载到 μPC。

- **图示流程**：
    - **μPC** 指向 CM 中的当前微指令。
    - 微指令读出到 **μIR**。
    - 微指令分为两部分：
        - **μOP**：微操作控制字段，产生控制信号。
        - **转移部分**：包含转移地址和转移条件。
    - **入口地址及转移地址产生器** 根据 **IR（用于初始入口）** 和 **状态标志（用于条件转移）**，在需要时修改 μPC 的值。

- **特点**：
    - **优点**：
        - **微指令字较短**：因为不需要一个完整的“下址”字段，只需在需要跳转时提供地址。
        - **结构简单**：逻辑清晰，易于实现。
    - **缺点**：
        - **多分支能力弱**：难以实现一条微指令后根据不同条件跳转到多个地址。
        - **地址分配不灵活**：微程序在控制存储器中的物理布局需要精心安排，以适应顺序地址。

**比喻**：就像**看书**。你默认一页一页顺序读（μPC+1）。只有当看到“转到第X页”的指令时，你才翻到那一页。书页（微指令）本身不需要写下下一页的页码。

---

#### 2. ==断定方式 (下址字段方式)==

- **原理**：每一条微指令都**自带“下一跳”地址**。这个地址放在一个专门的 **下址字段** 中。
    - **顺序执行**：下址字段直接就是下一条微指令的地址。
    - **==转移执行==**：通过 **测试判别字段** 和 **外部状态条件**，对下址字段进行**局部修改**，从而形成最终地址。

- **图示流程**：
    - **下址字段** 的值通常直接加载到 **μAR**。
    - **测试判别字段** 指明要测试哪个状态位（如运算结果Z）。
    - **PLA和微地址修改逻辑** 根据测试结果，去修改 μAR 中的某一位或几位。
        - *例如，下址是 `1100`，测试条件是“如果Z=1，则修改最低位”。那么当Z=1时，地址变为 `1101`；Z=0时，地址保持 `1100`。*

- **特点**：
    - **优点**：
        - **多路分支能力强**：可以轻松实现一条微指令后跟多个分支。
        - **地址分配灵活**：微程序可以存放在CM的任何位置，布局自由。
    - **缺点**：
        - **微指令字很长**：因为每条微指令都需要一个完整的下址字段。
        - **地址产生逻辑复杂**：需要额外的组合逻辑（PLA）来进行地址修改。

**断定方式的微指令格式**：**==OP + 测试判别字段 + 下址==**

---

### 总结与对比

| 特性 | **计数器方式 (μPC)** | **断定方式 (下址字段)** |
| :--- | :--- | :--- |
| **核心原理** | 顺序+1，跳转时加载 | 每条指令自带下址，条件修改 |
| **微指令字长** | **短** | **长** |
| **多分支能力** | 弱 | **强** |
| **CM地址分配** | 不灵活，需顺序布局 | **灵活**，可任意存放 |
| **硬件复杂度** | 简单 | 复杂（需要地址修改逻辑） |
| **好比** | **看书** | **“选择冒险”游戏书** |

**现代应用**：为了平衡，很多设计采用**混合方式**。例如，默认使用计数器方式顺序执行，但提供一位标志位来切换到断定方式以处理分支。这使得设计在获得断定方式灵活性的同时，又没有让微指令字长变得过分夸张。

理解了这两种方式，你就真正掌握了微程序控制器是如何“思考”和“流转”的。