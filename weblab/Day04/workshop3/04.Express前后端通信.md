# Express 中的前后端通信

## 一、最简单的例子

### 后端代码（server.js）
```javascript
const express = require('express');
const app = express();
const port = 3000;

// 1. 提供静态文件（前端HTML）
app.use(express.static('public'));

// 2. 创建API端点
app.get('/api/data', (req, res) => {
  res.json({ message: 'Hello from Express!' });
});

// 3. 启动服务器
app.listen(port, () => {
  console.log(`后端运行在 http://localhost:${port}`);
});
```

### 前端代码（public/index.html）
```html
<!DOCTYPE html>
<html>
<body>
  <h1>测试Express通信</h1>
  <button onclick="getData()">获取数据</button>
  <div id="result"></div>

  <script>
    async function getData() {
      // 访问Express后端的端点
      const response = await fetch('/api/data');
      const data = await response.json();
      document.getElementById('result').innerHTML = data.message;
    }
  </script>
</body>
</html>
```

---

## 二、Express 处理请求的5个核心方法

### 1. `app.get()` - 获取数据
```javascript
// 后端
app.get('/api/users', (req, res) => {
  const users = [
    { id: 1, name: '张三' },
    { id: 2, name: '李四' }
  ];
  res.json(users); // 发送JSON给前端
});

// 前端
fetch('/api/users')
  .then(res => res.json())
  .then(users => {
    console.log(users); // [{id:1,name:'张三'}, {id:2,name:'李四'}]
  });
```

### 2. `app.post()` - 提交数据
```javascript
// 后端（需要解析JSON）
app.use(express.json()); // 重要：先加这个中间件

app.post('/api/users', (req, res) => {
  // req.body 包含前端发送的数据
  const newUser = {
    id: Date.now(),
    name: req.body.name,
    age: req.body.age
  };
  
  // 保存到数据库（这里简化）
  console.log('收到用户:', newUser);
  
  // 返回给前端
  res.json({ success: true, user: newUser });
});

// 前端
fetch('/api/users', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ name: '王五', age: 25 })
});
```

### 3. `app.put()` - 更新数据
```javascript
// 后端
app.put('/api/users/:id', (req, res) => {
  const userId = req.params.id; // 获取URL中的id
  const newData = req.body; // 获取请求体数据
  
  console.log(`更新用户 ${userId}:`, newData);
  
  res.json({ success: true, message: '更新成功' });
});

// 前端
fetch('/api/users/123', {
  method: 'PUT',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ name: '新名字', age: 30 })
});
```

### 4. `app.delete()` - 删除数据
```javascript
// 后端
app.delete('/api/users/:id', (req, res) => {
  const userId = req.params.id;
  console.log(`删除用户 ${userId}`);
  
  res.json({ success: true, message: '删除成功' });
});

// 前端
fetch('/api/users/123', {
  method: 'DELETE'
});
```

### 5. `app.use()` - 所有请求都处理
```javascript
// 处理静态文件（前端代码）
app.use(express.static('public'));

// 解析JSON请求体
app.use(express.json());

// 自定义中间件（每个请求都经过）
app.use((req, res, next) => {
  console.log(`收到请求: ${req.method} ${req.url}`);
  next(); // 继续处理
});
```

---

## 三、完整通信示例

### 后端（server.js）
```javascript
const express = require('express');
const app = express();
const port = 3000;

// 中间件
app.use(express.json()); // 解析JSON
app.use(express.static('public')); // 静态文件

// 模拟数据库
let todos = [
  { id: 1, text: '学习Express', done: false },
  { id: 2, text: '写API', done: true }
];

// 1. 获取所有待办事项
app.get('/api/todos', (req, res) => {
  res.json(todos);
});

// 2. 添加新待办
app.post('/api/todos', (req, res) => {
  const newTodo = {
    id: todos.length + 1,
    text: req.body.text,
    done: false
  };
  todos.push(newTodo);
  res.json({ success: true, todo: newTodo });
});

// 3. 更新待办状态
app.put('/api/todos/:id', (req, res) => {
  const id = parseInt(req.params.id);
  const todo = todos.find(t => t.id === id);
  
  if (todo) {
    todo.done = req.body.done;
    res.json({ success: true, todo });
  } else {
    res.status(404).json({ error: '未找到' });
  }
});

// 4. 删除待办
app.delete('/api/todos/:id', (req, res) => {
  const id = parseInt(req.params.id);
  todos = todos.filter(t => t.id !== id);
  res.json({ success: true });
});

app.listen(port, () => {
  console.log(`服务器: http://localhost:${port}`);
  console.log(`API测试:`);
  console.log(`  GET    http://localhost:${port}/api/todos`);
  console.log(`  POST   http://localhost:${port}/api/todos`);
});
```

### 前端（public/index.html）
```html
<!DOCTYPE html>
<html>
<head>
  <title>待办事项</title>
</head>
<body>
  <h1>待办事项</h1>
  
  <!-- 添加待办 -->
  <input type="text" id="newTodo" placeholder="输入待办">
  <button onclick="addTodo()">添加</button>
  
  <!-- 待办列表 -->
  <ul id="todoList"></ul>
  
  <script>
    // 页面加载时获取数据
    window.onload = loadTodos;
    
    async function loadTodos() {
      const res = await fetch('/api/todos');
      const todos = await res.json();
      renderTodos(todos);
    }
    
    async function addTodo() {
      const input = document.getElementById('newTodo');
      const text = input.value;
      
      const res = await fetch('/api/todos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });
      
      input.value = '';
      loadTodos(); // 重新加载
    }
    
    async function toggleTodo(id, done) {
      await fetch(`/api/todos/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ done: !done })
      });
      loadTodos();
    }
    
    async function deleteTodo(id) {
      await fetch(`/api/todos/${id}`, {
        method: 'DELETE'
      });
      loadTodos();
    }
    
    function renderTodos(todos) {
      const list = document.getElementById('todoList');
      list.innerHTML = todos.map(todo => `
        <li>
          <input type="checkbox" 
                 ${todo.done ? 'checked' : ''}
                 onchange="toggleTodo(${todo.id}, ${todo.done})">
          <span style="${todo.done ? 'text-decoration:line-through' : ''}">
            ${todo.text}
          </span>
          <button onclick="deleteTodo(${todo.id})">删除</button>
        </li>
      `).join('');
    }
  </script>
</body>
</html>
```

---

## 四、Express 通信关键点

### 1. **发送数据用 `res.json()`**
```javascript
// 后端发送数据
res.json({ key: 'value' });
res.json([1, 2, 3]);
res.json({ success: true, data: [...] });
```

### 2. **获取前端数据用 `req.body`**
```javascript
// 需要先加中间件
app.use(express.json()); // 解析JSON
// 或
app.use(express.urlencoded({ extended: true })); // 解析表单

// 然后才能用 req.body
console.log(req.body.name);
console.log(req.body.age);
```

### 3. **获取URL参数用 `req.params`**
```javascript
// 定义路由时用 :id
app.get('/users/:id', (req, res) => {
  const userId = req.params.id; // 获取id
});

// 前端访问 /users/123
// req.params.id 就是 "123"
```

### 4. **获取查询参数用 `req.query`**
```javascript
// 前端访问 /api/search?q=express&page=1
app.get('/api/search', (req, res) => {
  const keyword = req.query.q;     // "express"
  const page = req.query.page;     // "1"
});
```

---

## 五、快速测试步骤

1. **创建项目**
```bash
mkdir express-test
cd express-test
npm init -y
npm install express
```

2. **创建 server.js**（用上面的完整示例）

3. **创建 public/index.html**（用上面的前端代码）

4. **运行**
```bash
node server.js
```

5. **访问**
- 浏览器打开：`http://localhost:3000`
- 测试API：`http://localhost:3000/api/todos`

---

## 六、一句话总结

**Express通信就是：**
- 前端：`fetch('/api/xxx')` 发请求
- 后端：`app.get/post/put/delete('/api/xxx', 处理函数)` 收请求
- 后端处理完后：`res.json(数据)` 返回
- 前端收到后：`.then(data => 使用数据)`