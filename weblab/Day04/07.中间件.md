好的，直接讲核心，不绕弯子。

# Express 中间件（精简版）

**中间件就是一系列按顺序执行的函数。每个函数都能处理请求，并决定是否继续传递。**

---

## 一、中间件是干什么的？

处理请求的每个步骤。比如：
1. 记录日志
2. 检查登录状态
3. 解析数据
4. 返回响应

---

## 二、基础语法

```javascript
// 定义一个中间件
app.use((req, res, next) => {
  // 处理逻辑...
  next(); // 必须调用，才能进入下一个中间件
});

// 或针对特定路径
app.use('/api', (req, res, next) => {
  // 只对 /api 开头的路径生效
  next();
});
```

---

## 三、三种常用中间件

### 1. 应用级别（对所有请求生效）
```javascript
const express = require('express');
const app = express();

// 记录每个请求
app.use((req, res, next) => {
  console.log(`${req.method} ${req.url}`);
  next();
});
```

### 2. 路由级别（对特定路由生效）
```javascript
// 只对 /user 路径生效
app.use('/user', (req, res, next) => {
  console.log('访问用户相关');
  next();
});

app.get('/user/profile', (req, res) => {
  res.send('用户资料');
});
```

### 3. 错误处理（必须有4个参数）
```javascript
// 放在所有路由最后
app.use((err, req, res, next) => {
  console.error(err);
  res.status(500).send('出错了');
});
```

---

## 四、核心规则

### 1. 顺序执行
先定义的先执行：

```javascript
app.use((req, res, next) => {
  console.log('第一');
  next();
});

app.use((req, res, next) => {
  console.log('第二');
  next();
});

app.get('/', (req, res) => {
  console.log('处理请求');
  res.send('完成');
});

// 访问 / 时输出：
// 第一
// 第二
// 处理请求
```

### 2. 必须调用 next()
```javascript
// 正确
app.use((req, res, next) => {
  console.log('通过');
  next(); // ✓
});

// 错误：请求会卡住
app.use((req, res, next) => {
  console.log('卡住了');
  // 忘记 next() ❌
});
```

### 3. 可以提前结束
```javascript
app.use((req, res, next) => {
  // 如果不符合条件，直接返回响应
  if (!req.headers.token) {
    return res.status(401).send('请登录');
  }
  next(); // 条件满足才继续
});
```

---

## 五、实际例子：记录请求时间

```javascript
const express = require('express');
const app = express();

// 中间件：记录开始时间
app.use((req, res, next) => {
  req.startTime = Date.now();
  next();
});

// 中间件：记录结束时间
app.use((req, res, next) => {
  res.on('finish', () => {
    const time = Date.now() - req.startTime;
    console.log(`${req.url} 耗时 ${time}ms`);
  });
  next();
});

// 路由
app.get('/', (req, res) => {
  res.send('首页');
});

app.listen(3000);
```

---

## 六、内置中间件（最常用的3个）

```javascript
const express = require('express');
const app = express();

// 1. 解析JSON请求体（POST/PUT请求的JSON数据）
app.use(express.json());

// 2. 解析表单数据
app.use(express.urlencoded({ extended: true }));

// 3. 提供静态文件（如图片、CSS、JS）
app.use(express.static('public'));

// 使用例子
app.post('/api/user', (req, res) => {
  // 可以获取到JSON数据
  console.log(req.body);
  res.json({ success: true });
});
```

---

## 七、一个完整例子

```javascript
const express = require('express');
const app = express();

// 1. 解析JSON
app.use(express.json());

// 2. 记录日志
app.use((req, res, next) => {
  console.log(`[${new Date().toLocaleTimeString()}] ${req.method} ${req.url}`);
  next();
});

// 3. 模拟登录检查
app.use((req, res, next) => {
  if (req.path.startsWith('/api') && !req.headers.token) {
    return res.status(401).json({ error: '需要token' });
  }
  next();
});

// 4. 路由
app.get('/', (req, res) => {
  res.send('首页');
});

app.post('/api/data', (req, res) => {
  res.json({ data: req.body });
});

// 5. 404处理（最后）
app.use((req, res) => {
  res.status(404).send('页面不存在');
});

// 6. 错误处理（最后）
app.use((err, req, res, next) => {
  res.status(500).send('服务器错误');
});

app.listen(3000);
```

---

## 总结要点

1. **中间件是函数**：`(req, res, next) => { ... }`
2. **next() 必须调用**：否则请求卡住
3. **顺序很重要**：按定义顺序执行
4. **可以修改 req/res**：添加数据或提前返回
5. **错误处理放最后**：`(err, req, res, next)`

**一句话：中间件就是请求处理的流水线，每个环节做一件事，通过 next() 传递到下一个环节。**