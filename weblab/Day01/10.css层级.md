好的！CSS 的层级（Hierarchy）是一个非常重要的概念，它决定了当多个 CSS 规则冲突时，哪个规则会最终生效。让我为你详细讲解。

## 1. CSS 层级的四个核心概念

CSS 层级主要由四个方面决定：
1. **重要性**（Importance）
2. **来源**（Source）
3. **特异性**（Specificity）
4. **顺序**（Order）

## 2. 重要性（Importance） - 最高优先级

### `!important` 规则
```css
p {
    color: blue !important;  /* 这个生效 */
}

p {
    color: red;              /* 这个不生效 */
}
```

**特点：**
- `!important` 拥有最高优先级
- 应该谨慎使用，通常只在覆盖第三方库样式时使用
- 多个 `!important` 冲突时，继续比较其他因素

## 3. 来源（Source） - 样式表的来源

优先级从高到低：
1. **用户样式表中的 `!important`**
2. **作者样式表中的 `!important`**
3. **作者样式表**（开发者写的 CSS）
4. **用户样式表**（浏览器用户自定义）
5. **浏览器默认样式**

## 4. 特异性（Specificity） - 最核心的概念

特异性计算规则：**选择器越具体，优先级越高**

### 特异性权重计算
按 (a, b, c, d) 四个数字计算：

| 选择器类型 | 示例 | 权重 | 计算 |
|------------|------|------|------|
| **行内样式** | `style="color: red"` | 1,0,0,0 | a=1 |
| **ID 选择器** | `#header` | 0,1,0,0 | b=1 |
| **类/属性/伪类** | `.class`, `[type="text"]`, `:hover` | 0,0,1,0 | c=1 |
| **元素/伪元素** | `div`, `p`, `::before` | 0,0,0,1 | d=1 |
| **通用选择器** | `*` | 0,0,0,0 | 无影响 |

### 特异性计算示例

```css
/* 特异性: 0,0,0,1 - (0,0,0,1) */
p { color: black; }

/* 特异性: 0,0,1,0 - (0,0,1,0) */
.highlight { color: yellow; }

/* 特异性: 0,0,1,1 - (0,0,1,1) */
p.highlight { color: orange; }

/* 特异性: 0,1,0,0 - (0,1,0,0) */
#main-content { color: blue; }

/* 特异性: 0,1,1,1 - (0,1,1,1) */
div#main-content p.highlight { color: purple; }

/* 行内样式: 1,0,0,0 - (1,0,0,0) */
<!-- <p style="color: red"> -->
```

### 实际比较示例
```html
<div id="container" class="box">
    <p class="text highlight">Hello World</p>
</div>
```

```css
/* 特异性: 0,0,0,1 = 1 */
p { color: black; }

/* 特异性: 0,0,1,0 = 10 */
.highlight { color: yellow; }

/* 特异性: 0,0,1,1 = 11 */
p.highlight { color: orange; }

/* 特异性: 0,0,2,1 = 21 */
.text.highlight { color: green; }

/* 特异性: 0,1,1,1 = 111 */
#container p.highlight { color: blue; }

/* 最终颜色是蓝色，因为特异性最高 */
```

## 5. 顺序（Order） - 最后的决胜局

当重要性和特异性都相同时，**后定义的规则**会覆盖先定义的规则。

```css
/* 这个生效，因为它在后面 */
p { color: blue; }
p { color: red; }  /* 红色生效 */
```

```css
/* 特异性相同，后面的生效 */
.btn { background: gray; }   /* 不生效 */
.btn { background: blue; }   /* 生效 */
```

## 6. 完整的层级顺序

从最高优先级到最低优先级：

```
1. 用户代理样式表中的 !important
2. 用户样式表中的 !important
3. 作者样式表中的 !important
4. 行内样式 (style属性)
5. ID 选择器
6. 类选择器、属性选择器、伪类
7. 元素选择器、伪元素
8. 通用选择器 (*)
9. 浏览器默认样式
```

## 7. 实际应用示例

### 示例 1：特异性比较
```html
<div id="page" class="container">
    <article class="post">
        <h1 class="title">标题</h1>
        <p>段落内容</p>
    </article>
</div>
```

```css
/* 特异性: 0,0,0,1 = 1 */
h1 { color: black; }

/* 特异性: 0,0,1,0 = 10 */
.title { color: blue; }

/* 特异性: 0,0,1,1 = 11 */
h1.title { color: green; }

/* 特异性: 0,1,1,1 = 111 */
#page article h1.title { color: red; }

/* 最终颜色：红色 */
```

### 示例 2：顺序的影响
```css
/* 定义基础按钮样式 */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
}

/* 定义主要按钮样式 */
.btn-primary {
    background: blue;
    color: white;
}

/* 特异性相同，但后定义的会覆盖 */
.btn {
    background: gray;  /* 不生效，因为后面有更具体的 */
}

.btn-primary {
    background: darkblue;  /* 生效 */
}
```

### 示例 3：!important 的使用
```css
/* 第三方库的样式 */
.third-party-btn {
    background: red !important;
}

/* 我们想要覆盖它 */
.our-btn {
    background: blue !important;  /* 这样能覆盖 */
}

.our-btn {
    background: green;  /* 这样不能覆盖，没有 !important */
}
```

## 8. 特异性计算练习

计算以下选择器的特异性：

```css
/* 特异性: 0,0,0,1 */
div

/* 特异性: 0,0,1,0 */
.container

/* 特异性: 0,0,1,1 */
div.container

/* 特异性: 0,1,0,0 */
#header

/* 特异性: 0,1,0,1 */
div#header

/* 特异性: 0,1,1,2 */
body div#header nav ul li a

/* 特异性: 0,0,3,1 */
a.btn.primary.large

/* 特异性: 0,0,1,0 */
:hover
```

## 9. 最佳实践和技巧

### 避免过度特异性
```css
/* ❌ 不好：特异性太高 */
header#main-nav ul li a.active { color: red; }

/* ✅ 更好：特异性适中 */
.nav-link.active { color: red; }

/* ✅ 最好：使用BEM命名法 */
.nav__link--active { color: red; }
```

### 合理使用类选择器
```css
/* 使用类选择器，避免ID选择器 */
.widget { }           /* 可复用 */
#main-widget { }      /* 尽量避免，除非真的需要唯一性 */

/* 使用组合类 */
.btn { }
.btn--large { }
.btn--primary { }
```

### 调试技巧
当样式不生效时，按以下顺序检查：
1. 是否有语法错误？
2. 选择器是否正确选中元素？
3. 特异性是否足够？
4. 是否有 `!important` 覆盖？
5. 顺序是否正确？

## 10. 现代 CSS 的特性问题

### CSS Variables 和特异性
```css
:root {
    --main-color: blue;
}

.component {
    --main-color: red;  /* 可以覆盖，但遵循特异性规则 */
    color: var(--main-color);
}
```

### 层叠层（Cascade Layers）
```css
/* 定义层的顺序 */
@layer base, components, utilities;

@layer base {
    p { color: black; }
}

@layer utilities {
    .text-red { color: red; }  /* 即使特异性低，也能覆盖base层 */
}
```

## 总结

记住这个简单的优先级顺序：

**!important > 行内样式 > ID > Class/属性/伪类 > 元素 > 通用选择器**

当遇到样式冲突时，按照这个顺序分析：
1. 有没有 `!important`？
2. 有没有行内样式？
3. 计算选择器特异性
4. 检查代码顺序

掌握 CSS 层级能让你：
- 更准确地预测样式效果
- 更好地调试样式问题
- 写出更可维护的 CSS 代码
- 避免不必要的 `!important` 使用