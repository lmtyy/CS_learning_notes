## 需求文件（requirements.txt）详解

### 1. **什么是 requirements.txt？**
requirements.txt 是 Python 项目的**依赖清单文件**，用于记录项目运行所需的所有第三方包及其版本。

### 2. **为什么需要它？**
- **环境一致性**：确保所有开发者和生产环境使用相同的依赖版本
- **便捷部署**：一键安装所有依赖
- **版本控制**：跟踪依赖变化历史
- **协作友好**：新成员快速搭建开发环境

### 3. **基本语法**

#### 简单格式：
```txt
package1
package2==1.0.0
package3>=2.1.0
package4<3.0.0
```

#### 版本限定符：
- `==`：精确版本
- `>=`：最低版本
- `<=`：最高版本
- `~=`：兼容版本（如 `~=2.2` 表示 `>=2.2,<3.0`）
- `!=`：排除版本

### 4. **实际示例**

```txt
# 基础依赖
django==3.2.5
requests>=2.25.1
numpy~=1.21.0

# 开发依赖（通常通过requirements-dev.txt分离）
pytest>=6.0.0
black==21.7b0

# 带环境标记的依赖
psycopg2-binary ; sys_platform != 'win32'
pywin32 ; sys_platform == 'win32'

# 从git仓库安装
git+https://github.com/user/repo.git@v1.0.0#egg=packagename

# 从本地文件安装
./downloads/SomePackage-1.0.4.tar.gz
```

### 5. **生成 requirements.txt**

#### 方法1：手动维护（推荐用于生产项目）
```bash
# 安装包时指定版本
pip install django==3.2.5

# 定期更新requirements.txt
pip freeze > requirements.txt
```

#### 方法2：使用 pip freeze（注意：会包含所有包）
```bash
# 生成当前环境所有包
pip freeze > requirements.txt

# 更精确的方法（使用pipreqs）
pip install pipreqs
pipreqs . --force  # 只生成项目实际import的包
```

### 6. **安装依赖**
```bash
# 安装所有依赖
pip install -r requirements.txt

# 安装指定环境的依赖
pip install -r requirements-dev.txt

# 使用清华镜像加速
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 7. **进阶用法**

#### 分层依赖文件结构：
```
requirements/
├── base.txt          # 基础依赖
├── production.txt    # 生产环境
├── development.txt   # 开发环境
└── test.txt         # 测试环境
```

#### production.txt 示例：
```txt
-r base.txt  # 包含基础依赖
gunicorn==20.1.0
psycopg2-binary==2.9.1
```

#### development.txt 示例：
```txt
-r base.txt
-r test.txt
pytest==6.2.5
ipython==8.0.0
pre-commit==2.17.0
```

### 8. **依赖锁定（高级）**

对于需要精确复现的环境，可以使用 `pip-tools`：

```bash
# requirements.in（手动维护）
django>=3.2
requests

# 生成锁定文件
pip-compile requirements.in
# 生成requirements.txt（包含所有传递依赖的精确版本）
```

### 9. **最佳实践**

1. **版本固定**：生产环境使用精确版本（`==`）
2. **定期更新**：使用 `pip list --outdated` 检查更新
3. **分离依赖**：开发/生产依赖分开
4. **注释说明**：在文件中添加必要注释
5. **安全扫描**：定期检查漏洞
```bash
pip install safety
safety check -r requirements.txt
```

### 10. **虚拟环境配合使用**

```bash
# 创建虚拟环境
python -m venv venv

# 激活（Windows）
venv\Scripts\activate

# 激活（Mac/Linux）
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 导出依赖
pip freeze > requirements.txt
```

### 11. **工具推荐**
- **pipreqs**：分析项目import语句生成requirements.txt
- **pip-tools**：依赖编译和锁定工具
- **poetry**：现代依赖管理工具（替代requirements.txt）
- **conda**：数据科学项目的环境管理

### 12. **常见问题**

#### 问题：requirements.txt 文件太大
**解决方案**：使用 `.pipignore` 或分离依赖

#### 问题：版本冲突
**解决方案**：使用 `pipdeptree` 分析依赖树
```bash
pip install pipdeptree
pipdeptree
```

这样管理依赖可以大大提高项目的可维护性和团队协作效率。