好的！SQL 函数是数据库中非常强大的工具，它们允许你对数据进行处理、转换和计算。我们来系统性地讲解一下 SQL 函数的用法。

### 一、SQL 函数是什么？

SQL 函数是预定义的操作，可以接受参数、执行操作并返回结果。它们就像编程语言中的函数一样，但直接在数据库层面操作数据。

### 二、函数的分类

SQL 函数主要分为两大类：

#### 1. 标量函数（Scalar Functions）
对单个值进行操作，每行返回一个结果。
```sql
SELECT UPPER(name) FROM users; -- 对每行的name字段进行操作
```

#### 2. 聚合函数（Aggregate Functions）
对一组值进行操作，返回单个汇总结果。
```sql
SELECT AVG(salary) FROM employees; -- 对所有salary求平均值
```

---

### 三、常用标量函数详解

#### 1. 字符串函数

| 函数 | 描述 | 示例 |
|------|------|------|
| `UPPER(str)` | 转为大写 | `UPPER('hello') → 'HELLO'` |
| `LOWER(str)` | 转为小写 | `LOWER('HELLO') → 'hello'` |
| `LENGTH(str)` | 字符串长度 | `LENGTH('hello') → 5` |
| `SUBSTRING(str, start, length)` | 提取子字符串 | `SUBSTRING('hello', 2, 3) → 'ell'` |
| `TRIM(str)` | 去除首尾空格 | `TRIM('  hello  ') → 'hello'` |
| `REPLACE(str, old, new)` | 替换字符串 | `REPLACE('hello', 'l', 'w') → 'hewwo'` |
| `CONCAT(str1, str2, ...)` | 连接字符串 | `CONCAT('hello', ' ', 'world') → 'hello world'` |

**示例：**
```sql
SELECT 
    name,
    UPPER(name) AS upper_name,
    LENGTH(name) AS name_length,
    SUBSTRING(name, 1, 3) AS first_three_chars
FROM users;
```

#### 2. 数值函数

| 函数 | 描述 | 示例 |
|------|------|------|
| `ROUND(num, decimals)` | 四舍五入 | `ROUND(123.4567, 2) → 123.46` |
| `CEIL(num)` | 向上取整 | `CEIL(23.1) → 24` |
| `FLOOR(num)` | 向下取整 | `FLOOR(23.9) → 23` |
| `ABS(num)` | 绝对值 | `ABS(-10) → 10` |
| `POWER(x, y)` | x的y次幂 | `POWER(2, 3) → 8` |
| `SQRT(num)` | 平方根 | `SQRT(9) → 3` |
| `MOD(x, y)` | 取余数 | `MOD(11, 4) → 3` |

**示例：**
```sql
SELECT 
    price,
    ROUND(price * 0.9, 2) AS discounted_price, -- 打9折
    CEIL(price) AS rounded_up
FROM products;
```

#### 3. 日期和时间函数

| 函数 | 描述 | 示例 |
|------|------|------|
| `CURRENT_DATE` | 当前日期 | `CURRENT_DATE → 2023-10-15` |
| `CURRENT_TIME` | 当前时间 | `CURRENT_TIME → 14:30:25` |
| `CURRENT_TIMESTAMP` | 当前日期时间 | `2023-10-15 14:30:25` |
| `DATE_PART(part, date)` | 提取日期部分 | `DATE_PART('year', date) → 2023` |
| `DATE_ADD(date, interval)` | 日期加法 | `DATE_ADD('2023-01-01', INTERVAL 1 MONTH)` |
| `DATEDIFF(date1, date2)` | 日期差 | `DATEDIFF('2023-12-31', '2023-01-01') → 364` |

**示例：**
```sql
SELECT 
    order_date,
    DATE_ADD(order_date, INTERVAL 30 DAY) AS due_date,
    DATEDIFF(CURRENT_DATE, order_date) AS days_since_order
FROM orders;
```

#### 4. 转换函数

| 函数 | 描述 | 示例 |
|------|------|------|
| `CAST(expr AS type)` | 类型转换 | `CAST('123' AS INT) → 123` |
| `COALESCE(val1, val2, ...)` | 返回第一个非NULL值 | `COALESCE(NULL, NULL, 'backup') → 'backup'` |
| `NULLIF(val1, val2)` | 两值相等返回NULL | `NULLIF(5, 5) → NULL` |

**示例：**
```sql
SELECT 
    name,
    COALESCE(phone, 'No Phone') AS contact_phone, -- 处理NULL值
    CAST(age AS VARCHAR) AS age_text -- 数字转字符串
FROM customers;
```

---

### 四、聚合函数详解

聚合函数对一组值执行计算，返回单个值。通常与 `GROUP BY` 一起使用。

| 函数 | 描述 | 示例 |
|------|------|------|
| `COUNT(expr)` | 计数 | `COUNT(*) → 行数` |
| `SUM(expr)` | 求和 | `SUM(salary) → 总工资` |
| `AVG(expr)` | 平均值 | `AVG(age) → 平均年龄` |
| `MIN(expr)` | 最小值 | `MIN(price) → 最低价格` |
| `MAX(expr)` | 最大值 | `MAX(score) → 最高分` |
| `GROUP_CONCAT(expr)` | 连接组内值 | `GROUP_CONCAT(name) → 'Alice,Bob,Charlie'` |

**示例：**
```sql
-- 基本的聚合
SELECT 
    COUNT(*) AS total_employees,
    AVG(salary) AS average_salary,
    MAX(salary) AS max_salary
FROM employees;

-- 与 GROUP BY 结合使用
SELECT 
    department,
    COUNT(*) AS employee_count,
    AVG(salary) AS avg_salary
FROM employees
GROUP BY department;

-- 使用 HAVING 过滤分组结果
SELECT 
    department,
    AVG(salary) AS avg_salary
FROM employees
GROUP BY department
HAVING AVG(salary) > 50000;
```

---

### 五、函数的组合使用

函数可以嵌套和组合使用，创建强大的数据转换：

```sql
-- 复杂的字符串处理
SELECT 
    UPPER(SUBSTRING(TRIM(name), 1, 1)) || LOWER(SUBSTRING(TRIM(name), 2)) AS formatted_name
FROM users;

-- 日期计算和格式化
SELECT 
    order_id,
    order_date,
    DATE_ADD(order_date, INTERVAL 30 DAY) AS due_date,
    DATEDIFF(CURRENT_DATE, order_date) AS days_passed,
    CONCAT('Order #', CAST(order_id AS VARCHAR)) AS order_label
FROM orders;
```

---

### 六、自定义函数（高级功能）

许多数据库系统允许创建自定义函数：

```sql
-- PostgreSQL 示例：创建自定义函数
CREATE OR REPLACE FUNCTION calculate_discount(price NUMERIC, discount_rate NUMERIC)
RETURNS NUMERIC AS $$
BEGIN
    RETURN price * (1 - discount_rate);
END;
$$ LANGUAGE plpgsql;

-- 使用自定义函数
SELECT product_name, price, calculate_discount(price, 0.1) AS discounted_price
FROM products;
```

---

### 七、重要注意事项

1.  **数据库兼容性**：不同数据库（MySQL、PostgreSQL、SQL Server）的函数名称和语法可能不同。
2.  **NULL 处理**：大多数函数遇到 NULL 参数会返回 NULL。
3.  **性能考虑**：在列上使用函数可能会阻止索引的使用。
    ```sql
    -- 不好：无法使用索引
    SELECT * FROM users WHERE UPPER(name) = 'JOHN';
    
    -- 更好：使用函数索引或应用程序层处理
    SELECT * FROM users WHERE name = 'JOHN';
    ```
4.  **执行顺序**：记住 SQL 的执行顺序：`FROM` → `WHERE` → `GROUP BY` → `HAVING` → `SELECT` → `ORDER BY`

### 总结

SQL 函数提供了强大的数据处理能力：
- **标量函数**：处理单行数据
- **聚合函数**：汇总多行数据  
- **可以嵌套组合**：创建复杂的数据转换
- **提高代码复用性**：减少应用程序层的处理逻辑

熟练掌握 SQL 函数能让你在数据库层面完成更多工作，写出更高效、更简洁的查询语句。