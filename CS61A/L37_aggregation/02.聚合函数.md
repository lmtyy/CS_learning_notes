好的！聚合函数是 SQL 中最强大和常用的功能之一。它们允许你对多行数据进行汇总计算，从而提取有意义的统计信息。

### 一、什么是聚合函数？

**聚合函数**是对一组值执行计算并返回**单个汇总值**的函数。它们将多行数据"聚合"成一个结果。

**核心特点**：
- 输入：多行数据
- 输出：单个值
- 通常与 `GROUP BY` 子句一起使用
- 忽略 `NULL` 值（除非使用 `COUNT(*)`）

---

### 二、常用的聚合函数

#### 1. `COUNT()` - 计数
计算行数或非NULL值的数量。

```sql
-- 计算总行数（包括NULL值）
SELECT COUNT(*) FROM employees;

-- 计算特定列的非NULL值数量
SELECT COUNT(department) FROM employees;

-- 计算唯一值的数量
SELECT COUNT(DISTINCT department) FROM employees;
```

#### 2. `SUM()` - 求和
计算数值列的总和。

```sql
-- 计算总工资
SELECT SUM(salary) FROM employees;

-- 计算每个部门的工资总和
SELECT department, SUM(salary) 
FROM employees 
GROUP BY department;
```

#### 3. `AVG()` - 平均值
计算数值列的平均值。

```sql
-- 计算平均工资
SELECT AVG(salary) FROM employees;

-- 计算每个部门的平均工资
SELECT department, AVG(salary) 
FROM employees 
GROUP BY department;
```

#### 4. `MIN()` - 最小值
找出一组值中的最小值。

```sql
-- 找出最低工资
SELECT MIN(salary) FROM employees;

-- 找出每个部门的最低工资
SELECT department, MIN(salary) 
FROM employees 
GROUP BY department;
```

#### 5. `MAX()` - 最大值
找出一组值中的最大值。

```sql
-- 找出最高工资
SELECT MAX(salary) FROM employees;

-- 找出每个部门的最高工资
SELECT department, MAX(salary) 
FROM employees 
GROUP BY department;
```

#### 6. `GROUP_CONCAT()` / `STRING_AGG()` - 字符串聚合
将多个值连接成一个字符串（数据库特定）。

```sql
-- MySQL
SELECT department, GROUP_CONCAT(name) 
FROM employees 
GROUP BY department;

-- PostgreSQL/SQL Server
SELECT department, STRING_AGG(name, ', ') 
FROM employees 
GROUP BY department;
```

---

### 三、聚合函数与 GROUP BY

聚合函数真正的威力在于与 `GROUP BY` 子句结合使用，可以按组进行聚合计算。

#### 基本语法：
```sql
SELECT column1, aggregate_function(column2)
FROM table_name
GROUP BY column1;
```

#### 示例数据：`employees` 表

| id | name | department | salary |
|----|------|------------|--------|
| 1 | Alice | Sales | 5000 |
| 2 | Bob | Sales | 6000 |
| 3 | Charlie | IT | 7000 |
| 4 | David | IT | 5500 |
| 5 | Eve | HR | 4500 |

#### 分组聚合示例：
```sql
SELECT 
    department,
    COUNT(*) AS employee_count,
    AVG(salary) AS average_salary,
    MIN(salary) AS min_salary,
    MAX(salary) AS max_salary,
    SUM(salary) AS total_salary
FROM employees
GROUP BY department;
```

**结果：**

| department | employee_count | average_salary | min_salary | max_salary | total_salary |
|------------|----------------|----------------|------------|------------|--------------|
| Sales | 2 | 5500 | 5000 | 6000 | 11000 |
| IT | 2 | 6250 | 5500 | 7000 | 12500 |
| HR | 1 | 4500 | 4500 | 4500 | 4500 |

---

### 四、HAVING 子句 - 过滤分组结果

`WHERE` 子句在分组前过滤行，而 `HAVING` 子句在分组后过滤组。

```sql
-- 找出平均工资超过5000的部门
SELECT department, AVG(salary) AS avg_salary
FROM employees
GROUP BY department
HAVING AVG(salary) > 5000;

-- 找出员工数超过1人的部门
SELECT department, COUNT(*) AS employee_count
FROM employees
GROUP BY department
HAVING COUNT(*) > 1;
```

**WHERE vs HAVING 的区别：**
- `WHERE`：在分组前过滤**行**，不能使用聚合函数
- `HAVING`：在分组后过滤**组**，可以使用聚合函数

---

### 五、多个分组列

你可以按多个列进行分组，创建更细粒度的汇总。

```sql
-- 按部门和职位分组统计
SELECT 
    department, 
    position,
    COUNT(*) AS count,
    AVG(salary) AS avg_salary
FROM employees
GROUP BY department, position;
```

---

### 六、聚合函数的注意事项

#### 1. NULL 值处理
聚合函数通常忽略 NULL 值：
```sql
-- 假设有5行，其中2行的salary为NULL
SELECT COUNT(salary) FROM employees; -- 返回3
SELECT COUNT(*) FROM employees;      -- 返回5
SELECT AVG(salary) FROM employees;   -- 只计算非NULL的3行
```

#### 2. 嵌套聚合
不能在聚合函数中嵌套另一个聚合函数：
```sql
-- 错误！
SELECT AVG(SUM(salary)) FROM employees GROUP BY department;

-- 正确：使用子查询
SELECT AVG(dept_total) 
FROM (
    SELECT SUM(salary) AS dept_total 
    FROM employees 
    GROUP BY department
) AS department_totals;
```

#### 3. SELECT 子句的规则
在使用 `GROUP BY` 时，`SELECT` 子句中只能包含：
- 分组列
- 聚合函数
- 常量

```sql
-- 错误：name不是分组列也不是聚合函数
SELECT department, name, AVG(salary)
FROM employees
GROUP BY department;

-- 正确
SELECT department, AVG(salary)
FROM employees
GROUP BY department;
```

---

### 七、高级聚合函数

#### 1. 窗口函数（现代SQL）
在保持行的同时进行聚合计算：
```sql
SELECT 
    name,
    department,
    salary,
    AVG(salary) OVER (PARTITION BY department) AS dept_avg_salary
FROM employees;
```

#### 2. 统计聚合函数
```sql
-- 标准差
SELECT STDDEV(salary) FROM employees;

-- 方差
SELECT VARIANCE(salary) FROM employees;

-- 中位数（某些数据库）
SELECT PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY salary) 
FROM employees;
```

---

### 八、实际应用示例

#### 1. 销售分析
```sql
SELECT 
    product_category,
    COUNT(*) AS total_orders,
    SUM(quantity) AS total_units,
    SUM(quantity * unit_price) AS total_revenue,
    AVG(quantity * unit_price) AS avg_order_value
FROM sales
GROUP BY product_category
HAVING SUM(quantity * unit_price) > 10000
ORDER BY total_revenue DESC;
```

#### 2. 用户行为分析
```sql
SELECT 
    user_id,
    COUNT(DISTINCT page_url) AS unique_pages_visited,
    MIN(visit_time) AS first_visit,
    MAX(visit_time) AS last_visit,
    COUNT(*) AS total_visits
FROM user_activity
GROUP BY user_id
HAVING COUNT(*) > 5;
```

### 总结

聚合函数是 SQL 数据分析的核心工具：
- **基础聚合**：`COUNT`, `SUM`, `AVG`, `MIN`, `MAX`
- **分组聚合**：与 `GROUP BY` 结合使用
- **过滤分组**：使用 `HAVING` 子句
- **高级功能**：窗口函数、统计函数等

掌握聚合函数可以让你从原始数据中提取出有价值的汇总信息，是进行数据分析和报告的基础。