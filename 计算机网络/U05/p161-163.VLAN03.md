这也是非常非常经典的一组课件，紧接上一节内容。

上一节我们讲到 VLAN 把公司分成了不同颜色的“逻辑组”（红、黑、绿）。这节课主要解决一个技术难题：**当红色组的员工 A 在 1 楼，红色组的员工 B 在 2 楼，它们之间的通信数据必然要穿过两台交换机之间的那根连线。这时候，交换机怎么知道这根线上传的数据到底是红组的，还是绿组的？**

这就引入了 **Trunk（干道）** 和 **802.1Q 帧格式** 的概念。我为你逐步解读：

---

### 第一部分：什么是 Trunk？ (Image 1)

*   **问题背景：** 交换机 A 和 B 之间通常只有一根网线连接。如果红、黑、绿三个部门的流量都要走这根线，就像三条车道的车汇入了一条单行道，这时候如果不加区分，到了对面就分不清谁是谁了。
*   **解决方案 —— Trunk Link (干道链路)：**
    *   **定义：** 一种特殊的连接模式，专门用来在交换机之间**承载多个 VLAN 的流量**。
    *   **核心机制：** **封装 (Encapsulation) / 标记**。就像图里展示的，原本独立的红、黑、绿数据包，在进入 Trunk 管道时，会被贴上各自的“颜色标签”。
    *   **比喻：** Trunk 就像一辆大巴车，里面既坐着要去红小学的学生，也坐着要去绿中学的学生。大家共用一辆车（物理线路），但每个人穿的校服（VLAN 标签）不同。

---

### 第二部分：标签的打上与撕下 (Image 2)

这张图展示了数据在网络中流动的完整生命周期，非常考研逻辑：

1.  **进入交换机 (Incoming Port)：**
    *   左上角的红色电脑发出一个普通的数据包。**注意：普通电脑发出的包是不带标签的。**
    *   交换机接收到后，因为知道这个端口是属于“红组”的，所以在数据包准备进入 Trunk 管道前，给它**打上 VLAN 标签 (VLAN Tag added)**。
2.  **在 Trunk 中传输 (Inter-Switch Link)：**
    *   带着红色标签的数据包穿过交换机之间的网线。
3.  **离开交换机 (Forwarding Port)：**
    *   右下角的交换机收到了带有红色标签的包。
    *   它查看标签，知道“哦，这是红组的”。
    *   在把数据转发给红组的目标电脑前，交换机会**把标签撕下来 (VLAN Tag stripped)**。
    *   **为什么？** 因为普通电脑（网卡）通常看不懂 VLAN 标签，给它标签它会认为是坏包。所以**VLAN 对用户是透明的**。

---

### 第三部分：802.1Q 帧格式 (Image 3) —— **核心考点**

这就是大名鼎鼎的 **IEEE 802.1Q 协议**（也叫 Dot1Q）。它规定了这个“标签”到底长什么样，塞在哪里。

*   **标签塞在哪里？**
    *   看图中最上方。原本的以太网帧是 `源地址(6字节) + 长度/类型(2字节) + 数据...`
    *   802.1Q 就像个插队的人，硬生生插在了 `源地址` 和 `长度/类型` **中间**。
    *   这个插入的标签一共由 **4个字节** 组成。

*   **这 4 个字节里有什么？ (考试常考)**
    1.  **TPID (0x8100)：** 前2个字节。这是个**暗号**。当网卡或交换机读到 `8100` 这个数时，它就明白了：“注意！后面跟的不是数据长度，而是一个 VLAN 标签！”
    2.  **TCI (标记控制信息)：** 后2个字节，包含：
        *   **Priority (用户优先级)：** 用来做 QoS 的，比如给语音流更高的优先级。
        *   **VLAN ID (关键中的关键)：** 占据了 **12 位 (bits)**。
        *   **考点计算：** $2^{12} = 4096$。所以，802.1Q 标准下，一个网络中**最多只能有 4096 个 VLAN** (实际上是 1-4094，0和4095保留)。

*   **副作用：**
    *   因为插了4个字节，原本以太网最大帧长是 1518 字节，现在变成了 **1522 字节**。这叫“Baby Giant Frame”。

---

### 总结（复习小抄）

1.  **Trunk 是什么？** 交换机之间用来跑多 VLAN 流量的“共享管道”。
2.  **Tagging 过程：** 进 Trunk 前打标签，出 Trunk 发给电脑前撕标签。
3.  **802.1Q：** 工业标准的 VLAN 协议。
    *   插入位置：源地址和类型之间。
    *   标识符：**0x8100**。
    *   最大 VLAN 数：**4096** (12位 ID)。