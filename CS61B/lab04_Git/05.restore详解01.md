# Git restore 命令详解

## 命令概述
`git restore` 是 Git 2.23+ 版本引入的新命令，用于恢复工作树中的文件。它替代了之前 `git checkout -- [file]` 和 `git reset [file]` 的部分功能。

## 基本语法
```bash
git restore [选项] [--] <路径名>...
```

## 三种主要使用场景

### 1. 丢弃工作区的修改（恢复到暂存区版本）
```bash
# 恢复单个文件
git restore filename.txt

# 恢复多个文件
git restore file1.txt file2.txt

# 恢复整个目录
git restore src/

# 恢复所有修改的文件
git restore .
```

**效果**：将工作区的文件恢复到最近一次 `git add` 或 `git commit` 时的状态

### 2. 从特定提交恢复文件
```bash
# 恢复到指定提交的版本
git restore --source=<commit-hash> filename.txt

# 使用相对引用
git restore --source=HEAD~1 filename.txt    # 恢复到上一个提交
git restore --source=HEAD~2 filename.txt    # 恢复到上两个提交
git restore --source=main filename.txt      # 恢复到main分支的最新版本
```

**获取 commit hash**：
```bash
git log --oneline          # 查看简化的提交历史
git log --pretty=format:"%h - %s"  # 自定义格式显示
```

### 3. 取消暂存的文件（从暂存区移除）
```bash
# 将文件从暂存区移回工作区
git restore --staged filename.txt

# 取消所有暂存的文件
git restore --staged .
```

## 选项参数详解

### 常用选项
| 选项 | 说明 | 示例 |
|------|------|------|
| `--source=<tree>` | 指定恢复的源提交 | `--source=abc1234` |
| `--staged` | 只影响暂存区 | `--staged file.txt` |
| `--worktree` | 只影响工作区（默认） | `--worktree file.txt` |
| `--ours` | 冲突时选择当前分支版本 | `--ours file.txt` |
| `--theirs` | 冲突时选择合并分支版本 | `--theirs file.txt` |
| `--patch` | 交互式选择恢复内容 | `--patch file.txt` |

### 组合使用
```bash
# 同时恢复工作区和暂存区
git restore --source=HEAD --staged --worktree filename.txt

# 等同于
git restore --source=HEAD filename.txt
```

## 实际应用场景

### 场景1：误修改后恢复
```bash
# 不小心修改了重要文件，想撤销修改
git restore important-file.java
```

### 场景2：恢复到历史版本
```bash
# 查看历史记录
git log --oneline
# 输出：a1b2c3d 修复登录功能
#        d4e5f6a 添加用户管理

# 恢复到"修复登录功能"的版本
git restore --source=a1b2c3d auth-service.js
```

### 场景3：取消错误暂存
```bash
# 不小心把调试文件暂存了
git add debug.log

# 从暂存区移除
git restore --staged debug.log
```

### 场景4：解决合并冲突
```bash
# 选择保留当前分支的版本
git restore --ours conflicted-file.txt

# 选择保留合并分支的版本  
git restore --theirs conflicted-file.txt
```

## 与旧命令的对比

| 新命令 | 等效的旧命令 | 说明 |
|--------|-------------|------|
| `git restore <file>` | `git checkout -- <file>` | 丢弃工作区修改 |
| `git restore --staged <file>` | `git reset HEAD <file>` | 取消暂存 |
| `git restore --source=X <file>` | `git checkout X -- <file>` | 恢复特定版本 |

## 安全使用建议

### 1. 先检查状态
```bash
# 恢复前先查看文件状态
git status
git diff filename.txt
```

### 2. 备份重要修改
```bash
# 如果不想完全丢失当前修改，可以先暂存
git stash save "临时保存的修改"
# 或者创建备份分支
git branch backup-branch
```

### 3. 测试恢复结果
```bash
# 恢复后检查文件内容
cat filename.txt
# 或者用diff比较
git diff filename.txt
```

## 常见问题解答

### Q: `git restore` 会删除文件吗？
**A**: 如果文件在源提交中不存在，`git restore --source=<commit>` 会删除工作区的该文件。

### Q: 恢复后能撤销吗？
**A**: 不能直接撤销。建议重要修改先 commit 或 stash。

### Q: 如何恢复被删除的文件？
```bash
# 恢复被删除的文件
git restore --source=HEAD deleted-file.txt
```

### Q: 与 `git reset` 的区别？
**A**: `git reset` 移动分支指针，`git restore` 只修改文件内容。

## 完整工作流示例

```bash
# 1. 查看当前状态
git status

# 2. 查看要恢复的文件差异
git diff modified-file.txt

# 3. 恢复到最新提交版本
git restore modified-file.txt

# 4. 验证恢复结果
git status
git diff modified-file.txt
```

## 总结
`git restore` 是一个强大而精确的文件恢复工具，通过不同的选项组合可以灵活处理各种恢复场景。掌握这个命令可以大大提高版本控制的效率和安全性。